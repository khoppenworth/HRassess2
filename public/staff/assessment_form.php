<?php require __DIR__.'/../../app/bootstrap.php'; require_login(); $pdo=db(); $id=(int)($_GET['id']??0); $ass=row($pdo->prepare('SELECT * FROM assessments WHERE id=?'),[$id]); if(!$ass || $ass['user_id']!=current_user()['id']){ http_response_code(403); exit('Forbidden'); } if($_SERVER['REQUEST_METHOD']==='POST'){ foreach($_POST['item']??[] as $iid=>$v){ $self=max(1,min(5,(int)($v['self_score']??0))); $ev=trim($v['evidence']??''); upsert_response($id,(int)$iid,$self,null,$ev,null);} if(isset($_POST['submit_final'])){ $pdo->prepare("UPDATE assessments SET status='submitted', submitted_at=NOW() WHERE id=?")->execute([$id]); compute_scores($id); header('Location: /'); exit;} $saved=true;} include __DIR__.'/../../views/partials/header.php'; echo '<div class=container mt-3><h3>Self-Assessment</h3>'; if(!empty($saved)) echo '<div class="alert alert-success">Saved.</div>'; echo '<form method=post>'; $areas=qall($pdo->prepare('SELECT * FROM competency_areas WHERE questionnaire_id=? ORDER BY name'),[$ass['questionnaire_id']]); foreach($areas as $a){ echo '<div class="card mb-3"><div class="card-header">'.htmlspecialchars($a['name']).'</div><div class=card-body>'; $items=qall($pdo->prepare('SELECT * FROM items WHERE area_id=? ORDER BY id'),[$a['id']]); echo '<table class="table table-sm"><thead><tr><th>Item</th><th>Self(1-5)</th><th>Evidence URL</th></tr></thead><tbody>'; foreach($items as $it){ $r=row($pdo->prepare('SELECT * FROM responses WHERE assessment_id=? AND item_id=?'),[$id,$it['id']]); echo '<tr><td>'.htmlspecialchars($it['text']).' <span class="text-muted small">(W '.$it['weight_pct'].'%)</span></td><td><input name="item['.$it['id'].'][self_score]" type=number min=1 max=5 class="form-control form-control-sm" value="'.htmlspecialchars($r['self_score']??'').'"></td><td><input name="item['.$it['id'].'][evidence]" class="form-control form-control-sm" value="'.htmlspecialchars($r['evidence_url']??'').'"></td></tr>'; } echo '</tbody></table></div></div>'; } echo '<button class="btn btn-primary" name=save>Save Draft</button> <button class="btn btn-success" name=submit_final>Submit</button></form></div>'; include __DIR__.'/../../views/partials/footer.php';
