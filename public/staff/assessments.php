<?php require __DIR__.'/../../app/bootstrap.php'; require_login(); $q=db()->query('SELECT id FROM questionnaires ORDER BY id DESC LIMIT 1')->fetch(); if(!$q){ echo 'No questionnaire. Admin import needed.'; exit; } $u=current_user(); $ass=row(db()->prepare('SELECT * FROM assessments WHERE user_id=? AND questionnaire_id=? AND status IN ("draft","submitted") ORDER BY id DESC LIMIT 1'),[$u['id'],$q['id']]); if(!$ass){ db()->prepare('INSERT INTO assessments (user_id,questionnaire_id,period,status,created_at) VALUES (?,?,?,?,NOW())')->execute([$u['id'],$q['id'],date('Y')."Q".ceil(date('n')/3),'draft']); $ass_id=db()->lastInsertId(); } else { $ass_id=$ass['id']; } header('Location: /staff/assessment_form.php?id='.$ass_id);
