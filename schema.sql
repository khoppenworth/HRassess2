-- schema.sql
CREATE TABLE IF NOT EXISTS users(id INT AUTO_INCREMENT PRIMARY KEY,username VARCHAR(190) UNIQUE NOT NULL,password VARCHAR(255) NOT NULL,role ENUM('admin','staff') NOT NULL DEFAULT 'admin',full_name VARCHAR(190),email VARCHAR(190),created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS app_settings(id INT PRIMARY KEY DEFAULT 1,site_name VARCHAR(190) DEFAULT 'EPSS',logo_path VARCHAR(255) DEFAULT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
INSERT INTO app_settings (id,site_name) VALUES (1,'EPSS') ON DUPLICATE KEY UPDATE site_name=VALUES(site_name);
CREATE TABLE IF NOT EXISTS questionnaires(id INT AUTO_INCREMENT PRIMARY KEY,code VARCHAR(64),title VARCHAR(255) NOT NULL,description TEXT,created_by INT,created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS item_banks(id INT AUTO_INCREMENT PRIMARY KEY,name VARCHAR(190) NOT NULL,description TEXT) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS questions(id INT AUTO_INCREMENT PRIMARY KEY,questionnaire_id INT NOT NULL,item_bank_id INT NULL,section VARCHAR(190),text TEXT NOT NULL,max_score INT NOT NULL DEFAULT 5,weight_percent INT NOT NULL DEFAULT 100,FOREIGN KEY (questionnaire_id) REFERENCES questionnaires(id) ON DELETE CASCADE,FOREIGN KEY (item_bank_id) REFERENCES item_banks(id) ON DELETE SET NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS assessments(id INT AUTO_INCREMENT PRIMARY KEY,user_id INT NOT NULL,questionnaire_id INT NOT NULL,started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,completed_at TIMESTAMP NULL,total_score DECIMAL(10,2) DEFAULT 0,FOREIGN KEY (user_id) REFERENCES users(id),FOREIGN KEY (questionnaire_id) REFERENCES questionnaires(id)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS responses(id INT AUTO_INCREMENT PRIMARY KEY,assessment_id INT NOT NULL,question_id INT NOT NULL,score INT NOT NULL,FOREIGN KEY (assessment_id) REFERENCES assessments(id) ON DELETE CASCADE,FOREIGN KEY (question_id) REFERENCES questions(id) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS api_tokens(id INT AUTO_INCREMENT PRIMARY KEY,token VARCHAR(64) UNIQUE NOT NULL,label VARCHAR(190),created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
